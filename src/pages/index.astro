---
import Layout from "../layouts/MigratedLayout.astro";
import { loadWp, WP_HOST } from "../lib/wp";
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

/* ---------------------------
   Helpers: HTML → testo pulito
--------------------------- */

function decodeHtmlEntities(input: string): string {
  return input
    // hex entities &#x2019;
    .replace(/&#x([0-9a-fA-F]+);/g, (_m, hex) => {
      const cp = parseInt(hex, 16);
      return Number.isFinite(cp) ? String.fromCodePoint(cp) : _m;
    })
    // numeric entities &#8217;
    .replace(/&#(\d+);/g, (_m, num) => {
      const cp = parseInt(num, 10);
      return Number.isFinite(cp) ? String.fromCodePoint(cp) : _m;
    })
    // named (principali)
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&quot;/g, '"')
    .replace(/&apos;/g, "'")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">");
}

function textFromHtml(html: unknown): string {
  if (typeof html !== "string") return "";
  const decoded = decodeHtmlEntities(html);
  return decoded
    .replace(/<script[\s\S]*?<\/script>/gi, " ")
    .replace(/<style[\s\S]*?<\/style>/gi, " ")
    .replace(/<[^>]+>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function excerptFromHtml(html: unknown, max = 150): string {
  const t = textFromHtml(html);
  if (!t) return "";
  if (t.length <= max) return t;
  return t.slice(0, max).replace(/\s+\S*$/, "").trim() + "…";
}

/* ---------------------------
   Routing / URL normalization
--------------------------- */

function internalHref(link: unknown): string {
  if (typeof link !== "string") return "#";
  const s = link.trim();
  if (!s) return "#";

  if (s.startsWith("/")) return s.endsWith("/") ? s : s + "/";

  try {
    const u = new URL(s, "https://canapalandia.com");
    const host = u.hostname.replace(/^www\./i, "");

    // esterno → lascia assoluto
    if (host && host !== "canapalandia.com") return s;

    const p = u.pathname || "/";
    return p.endsWith("/") ? p : p + "/";
  } catch {
    const stripped = s.replace(/^https?:\/\/[^/]+/i, "");
    const p = stripped.startsWith("/") ? stripped : "/" + stripped;
    return p.endsWith("/") ? p : p + "/";
  }
}

function entryHref(p: any): string {
  const raw = p?.path ?? p?.uri ?? p?.slug ?? p?.link ?? "";
  return internalHref(raw);
}

/* ---------------------------
   Media resolution (mirror / hotlink)
--------------------------- */

const PUBLIC_DIR = path.resolve(
  path.dirname(fileURLToPath(import.meta.url)),
  "../../public"
);

function resolveWpMediaSrc(src: unknown): string {
  if (typeof src !== "string") return "";
  let s = src.trim();
  if (!s) return "";

  if (s.startsWith("//")) s = `https:${s}`;

  // relativo
  if (s.startsWith("/")) {
    const local = path.join(PUBLIC_DIR, s.replace(/^\//, ""));
    return fs.existsSync(local) ? s : `${WP_HOST}${s}`;
  }

  // assoluto
  try {
    const u = new URL(s);
    const host = u.hostname.replace(/^www\./i, "");
    const pathname = u.pathname || "/";

    if (host === "canapalandia.com") {
      const local = path.join(PUBLIC_DIR, pathname.replace(/^\//, ""));
      return fs.existsSync(local) ? pathname : s;
    }

    return s;
  } catch {
    return s;
  }
}

function featuredImage(p: any): { src: string; alt: string } | null {
  // 1) campo normalizzato
  const direct = p?.featuredImage ?? p?.featured_image ?? p?.image ?? null;

  if (typeof direct === "string" && direct.trim()) {
    return { src: resolveWpMediaSrc(direct.trim()), alt: "" };
  }

  if (direct && typeof direct === "object") {
    const src =
      (direct as any)?.src ??
      (direct as any)?.url ??
      (direct as any)?.source_url;

    const alt =
      (direct as any)?.alt ??
      (direct as any)?.alt_text ??
      "";

    if (typeof src === "string" && src.trim()) {
      return { src: resolveWpMediaSrc(src.trim()), alt: String(alt ?? "") };
    }
  }

  // 2) fallback WP raw embedded
  const fm = p?.raw?._embedded?.["wp:featuredmedia"]?.[0];
  const srcRaw =
    fm?.media_details?.sizes?.medium_large?.source_url ||
    fm?.media_details?.sizes?.large?.source_url ||
    fm?.media_details?.sizes?.full?.source_url ||
    fm?.source_url;

  const alt = fm?.alt_text || fm?.title?.rendered || "";

  if (typeof srcRaw === "string" && srcRaw.trim()) {
    return { src: resolveWpMediaSrc(srcRaw.trim()), alt: String(alt ?? "") };
  }

  return null;
}

/* ---------------------------
   Data: WP headless
--------------------------- */

const { entries: wpEntries = [] } = await loadWp();
const entries: any[] = Array.isArray(wpEntries) ? wpEntries : [];

const posts = entries.filter(
  (e) => typeof e?.title === "string" && typeof e?.html === "string"
);

const getTime = (p: any) => {
  const raw = p?.date ?? p?.modified ?? p?.modifiedGmt ?? "";
  const t = Date.parse(String(raw));
  return Number.isFinite(t) ? t : 0;
};

const sortedPosts = posts.slice().sort((a, b) => getTime(b) - getTime(a));
const latestPosts = sortedPosts.slice(0, 6);
const featured = sortedPosts[0];
const featuredSide = sortedPosts.slice(1, 4);

/* ---------------------------
   Page meta
--------------------------- */

const heroBgVar = "none";
const title = "Canapalandia — Cannabis light, CBD e canapa legale in Italia";
const canonical = "https://canapalandia.com/";
---

<Layout title={title} canonical={canonical} shell={false}>
  <section class="hero" style={`--hero-bg:${heroBgVar}`}>
    <div class="hero-overlay" aria-hidden="true"></div>

    <div class="container hero-inner">
      <p class="kicker">Cannabis legale • CBD • Canapa industriale</p>

      <h1>
        Cannabis light, CBD e canapa legale in Italia:
        informazione chiara e verificabile
      </h1>

      <p class="lead">
        Notizie, normative e guide pratiche per orientarti tra leggi, prodotti, ricerca e filiera.
        Focus Italia, aggiornamenti continui, zero sensazionalismo.
      </p>

      <div class="hero-cta">
        <a class="btn primary" href="/#percorsi">Inizia dai percorsi</a>
        <a class="btn ghost" href="/#ultimi">Leggi le ultime notizie</a>
      </div>

      <ul class="trust" aria-label="Punti chiave">
        <li>Focus Italia</li>
        <li>Fonti e contesto</li>
        <li>Aggiornato</li>
        <li>No promozione illegalità</li>
      </ul>
    </div>
  </section>

  <section id="percorsi" class="section">
    <div class="container">
      <div class="section-head">
        <h2>Percorsi tematici</h2>
        <p class="section-lead">
          Entra subito nell’area giusta: normative, benessere, filiera e approfondimenti.
        </p>
      </div>

      <div class="grid cards">
        <a class="card" href="/categoria/normative-aspetti-legali/">
          <h3>Normativa e aspetti legali</h3>
          <p>Leggi, sentenze, decreti e cosa cambia davvero in Italia.</p>
        </a>

        <a class="card" href="/categoria/salute-benessere/">
          <h3>CBD e benessere</h3>
          <p>Uso consapevole, ricerca, qualità, sicurezza e limiti.</p>
        </a>

        <a class="card" href="/categoria/cannabis-news-it/">
          <h3>Cannabis news</h3>
          <p>Attualità selezionata, senza panico morale né clickbait.</p>
        </a>

        <a class="card" href="/categoria/coltivazione-legale/">
          <h3>Canapa industriale</h3>
          <p>Filiera, economia, sostenibilità e applicazioni reali.</p>
        </a>

        <a class="card" href="/categoria/guide-tutorial/">
          <h3>Guide pratiche</h3>
          <p>Glossario, come leggere un COA, cosa guardare prima di acquistare.</p>
        </a>

        <a class="card" href="/categoria/partner-e-affiliazioni/">
          <h3>Partner selezionati</h3>
          <p>Collaborazioni trasparenti e risorse utili per supportare il progetto.</p>
        </a>
      </div>
    </div>
  </section>

  <section id="in-evidenza" class="section alt">
    <div class="container">
      <div class="section-head">
        <h2>In evidenza</h2>
        <p class="section-lead">
          Una guida “pilastro” e tre letture correlate per farti un quadro completo.
        </p>
      </div>

      <div class="grid featured">
        {featured ? (
          <a class="feature-main" href={entryHref(featured)}>
            <p class="badge">Approfondimento</p>

            {(() => {
              const fi = featuredImage(featured);
              return fi ? (
                <img
                  class="feature-img"
                  src={fi.src}
                  alt={fi.alt || textFromHtml(featured.title)}
                  loading="eager"
                  decoding="async"
                />
              ) : (
                <div class="feature-img feature-img--placeholder" aria-hidden="true"></div>
              );
            })()}

            <h3 class="feature-title" set:html={featured.title} />
            <p class="feature-excerpt">{excerptFromHtml(featured.html, 180)}</p>
            <span class="btn small">Leggi</span>
          </a>
        ) : (
          <div class="feature-main">
            <p>Selezione in evidenza in arrivo.</p>
          </div>
        )}

        <div class="feature-side">
          {featuredSide.map((p) => (
            <a class="mini" href={entryHref(p)}>
              {(() => {
                const fi = featuredImage(p);
                return fi ? (
                  <img
                    class="mini-img"
                    src={fi.src}
                    alt={fi.alt || textFromHtml(p.title)}
                    loading="lazy"
                    decoding="async"
                  />
                ) : (
                  <div class="mini-img mini-img--placeholder" aria-hidden="true"></div>
                );
              })()}

              <div class="mini-body">
                <h3 class="mini-title" set:html={p.title} />
                <p class="mini-excerpt">{excerptFromHtml(p.html, 90)}</p>
                <span class="mini-link">Leggi</span>
              </div>
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <section id="ultimi" class="section">
    <div class="container">
      <div class="section-head">
        <h2>Ultimi articoli</h2>
        <p class="section-lead">Aggiornamenti e analisi. Scegli cosa leggere in base al tema.</p>
      </div>

      <div class="grid">
        {latestPosts.map((p) => (
          <article class="card post-card">
            <a class="cardLink" href={entryHref(p)}>
              <div class="thumb">
                {(() => {
                  const fi = featuredImage(p);
                  return fi ? (
                    <img
                      src={fi.src}
                      alt={fi.alt || textFromHtml(p.title)}
                      loading="lazy"
                      decoding="async"
                    />
                  ) : null;
                })()}
              </div>

              <div class="cardBody">
                <p class="cardMeta">
                  {(() => {
                    const iso = p?.date ?? p?.modified ?? "";
                    return iso
                      ? new Date(iso).toLocaleDateString("it-IT", {
                          year: "numeric",
                          month: "long",
                          day: "2-digit",
                        })
                      : "";
                  })()}
                </p>

                <h3 class="cardTitle" set:html={p.title} />
                <p class="cardExcerpt">{excerptFromHtml(p.html, 110)}</p>
                <span class="cardCta">Apri →</span>
              </div>
            </a>
          </article>
        ))}
      </div>

      <div class="section-cta">
        <a class="btn ghost" href="/blog/">Vai al blog</a>
      </div>
    </div>
  </section>

  <section class="section alt">
    <div class="container tool">
      <div class="tool-inner">
        <div>
          <h2>Il Ribaltatore</h2>
          <p class="section-lead">
            Un esperimento editoriale: trasformare slogan e frasi “proibizioniste” in domande utili,
            ironiche e condivisibili.
          </p>
        </div>
        <a class="btn primary" href="/ribaltatore/">Provalo</a>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container support">
      <div>
        <h2>Supporta Canapalandia</h2>
        <p class="section-lead">
          Se trovi utile il progetto, puoi sostenerlo o scoprire i partner selezionati.
        </p>
      </div>
      <div class="support-cta">
        <a class="btn primary" href="/sostieni-la-nostra-causa/">Sostieni il progetto</a>
        <a class="btn ghost" href="/partner-selezionati/">Scopri i partner</a>
      </div>
    </div>
  </section>
</Layout>