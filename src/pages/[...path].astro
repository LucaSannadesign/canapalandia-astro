---
import Layout from "../layouts/MigratedLayout.astro";
import { loadWp, WP_HOST } from "../lib/wp";
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

/* ---------------------------
   Utils
--------------------------- */
function normalizePathParam(input: unknown): string {
  if (input == null) return "";
  const s = Array.isArray(input) ? input.join("/") : String(input);
  return s.replace(/^\/+/, "").replace(/\/+$/, "");
}

/* ---------------------------
   Route / Data
--------------------------- */
const slug = normalizePathParam(Astro.params.path);
const uri = `/${slug ? slug + "/" : ""}`;

const { entries } = await loadWp();
const page = entries.find((e) => e?.path === slug);

if (!page) Astro.response.status = 404;

/* ---------------------------
   Meta
--------------------------- */
const title = page?.title || "Canapalandia";
const yoastHeadHtml = page?.yoastHead || null;
const canonical = `https://canapalandia.com${uri}`;
const contentHtml = page?.html || "";

/* ---------------------------
   Featured image: locale se esiste, altrimenti hotlink
--------------------------- */
const PUBLIC_DIR = path.resolve(path.dirname(fileURLToPath(import.meta.url)), "../../public");

function resolveMediaSrc(src?: string): string {
  if (!src) return "";
  let s = String(src).trim();
  if (!s) return "";

  if (s.startsWith("//")) s = `https:${s}`;

  // relativo
  if (s.startsWith("/")) {
    const local = path.join(PUBLIC_DIR, s.replace(/^\//, ""));
    return fs.existsSync(local) ? s : `${WP_HOST}${s}`;
  }

  // assoluto
  try {
    const u = new URL(s);
    const host = u.hostname.replace(/^www\./i, "");
    const pathname = u.pathname || "/";

    // nostro dominio: prova mirror locale
    if (host === "canapalandia.com") {
      const local = path.join(PUBLIC_DIR, pathname.replace(/^\//, ""));
      return fs.existsSync(local) ? pathname : s;
    }

    return s;
  } catch {
    return s;
  }
}

const heroImg =
  page?.featuredImage?.src ? resolveMediaSrc(page.featuredImage.src) : "";
const heroAlt =
  page?.featuredImage?.alt || page?.title || "Immagine in evidenza";
---

<Layout title={title} canonical={canonical} yoastHeadHtml={yoastHeadHtml}>
  {page ? (
    <>
      {heroImg ? (
        <header class="post-hero">
          {/* full-bleed banner */}
          <div class="post-hero__media">
            <img
              class="post-hero__img"
              src={heroImg}
              alt={heroAlt}
              loading="eager"
              decoding="async"
            />
          </div>

          {/* titolo nel container */}
          <div class="container">
            <div class="post-hero__content">
              <h1 class="post-hero__title" set:html={page.title} />
            </div>
          </div>
        </header>
      ) : (
        <section class="wp-page">
          <h1 set:html={page.title} />
        </section>
      )}

      <article class="wp-page" set:html={contentHtml} />
    </>
  ) : (
    <section class="wp-page">
      <h1>Pagina non trovata</h1>
      <p>La risorsa richiesta non Ã¨ disponibile.</p>
      <p><a href="/">Torna alla home</a></p>
    </section>
  )}
</Layout>