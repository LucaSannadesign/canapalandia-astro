---
import Layout from "../../layouts/MigratedLayout.astro";
import postsJson from "../../../data/wp/out/posts.json";
import categoriesJson from "../../../data/wp/out/categories.json";

export const prerender = false;

const slug = Astro.params.slug || "";
const posts = Array.isArray(postsJson) ? postsJson : [];
const cats = Array.isArray(categoriesJson) ? categoriesJson : [];

const stripHtml = (s) => String(s || "").replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
const postTitle = (p) => p?.title?.rendered || p?.title || "";
const excerpt = (p) => stripHtml(p?.excerpt?.rendered || p?.excerpt || "").slice(0, 180);
const sortDesc = (a, b) => (Date.parse(b?.date || b?.modified || "") || 0) - (Date.parse(a?.date || a?.modified || "") || 0);
const og = (p) => p?.yoast_head_json?.og_image?.[0]?.url || p?.yoast_head_json?.og_image?.[0]?.src || "";
const href = (p) => (p?.slug ? `/${p.slug}/` : "#");
const fmt = (iso) => (iso ? new Date(iso).toLocaleDateString("it-IT", { year:"numeric", month:"long", day:"2-digit" }) : "");

const cat = cats.find((c) => String(c?.slug || "") === slug);
const catId = cat?.id;

const filtered = catId
  ? posts.filter((p) => Array.isArray(p?.categories) && p.categories.includes(catId)).slice().sort(sortDesc)
  : [];

const title = cat ? `Categoria: ${cat.name} — Canapalandia` : "Categoria — Canapalandia";
const canonical = `https://canapalandia.com/categoria/${slug}/`;
---
<Layout title={title} canonical={canonical}>
  <section class="hero">
    <p class="kicker">Categoria</p>
    <h1>{cat?.name || "Categoria non trovata"}</h1>
    <p>{cat?.description ? stripHtml(cat.description) : "Contenuti filtrati per categoria."}</p>
    <div class="meta">
      <a class="btn btn-ghost" href="/blog/">← Blog</a>
      <a class="btn" href="/">Home</a>
    </div>
  </section>

  {cat ? (
    <section>
      <div class="grid">
        {filtered.slice(0, 48).map((p) => (
          <article class="card">
            <a class="cardLink" href={href(p)}>
              <div class="thumb">{og(p) ? <img src={og(p)} alt={stripHtml(postTitle(p))} loading="lazy" /> : null}</div>
              <div class="cardBody">
                <p class="cardMeta">{fmt(p?.date || p?.modified)}</p>
                <h3 class="cardTitle" set:html={postTitle(p)} />
                <p class="cardExcerpt">{excerpt(p)}</p>
                <span class="cardCta">Apri →</span>
              </div>
            </a>
          </article>
        ))}
      </div>
    </section>
  ) : (
    <section class="articleWrap"><div class="articleInner"><p>Slug: <strong>{slug}</strong></p></div></section>
  )}
</Layout>